### 并发(Concurrency)

---

1. 并发与并行:
    - 并发: 在同一时刻只能有一条指令执行, 但多个进程指令被快速的轮换执行,  
      使得在宏观上具有多个进程同时执行的效果, 但在微观上并不是同时执行的,  
      只是把时间分成若干段, 使多个进程快速交替的执行.
    - 并行(Parallelism): 在同一时刻, 有多条指令在多个处理器上同时执行,  
      无论从微观还是从宏观来看, 二者都是一起执行的.
    - 区别:
        - 并行指多个事件在同一个时刻发生; 并发指在某时刻只有一个事件发生,  
          某个时间段内由于CPU交替执行, 可以发生多个事件.
        - 并行没有对CPU资源的抢占; 并发执行的线程需要对CPU资源进行抢占.
        - 并行执行的线程之间不存在切换; 并发操作系统会根据任务调度系统  
          给线程分配线程的CPU执行时间, 线程的执行会进行切换.

---

2. 线程与进程:
    - 进程:
        - 程序执行时的一个实例.
        - 每个进程都有独立的内存地址空间.
        - 系统进行资源分配和调度的基本单位.
        - 进程里的堆, 是一个进程中最大的一块内存, 被进程中的所有线程共享的,  
          进程创建时分配, 主要存放 new 创建的对象实例.
        - 进程里的方法区, 是用来存放进程中的代码片段的, 是线程共享的.
        - 在多线程OS中, 进程不是一个可执行的实体,  
          即一个进程至少创建一个线程去执行代码.
    - 线程:
        - 为什么会有线程: 每个进程都有自己的地址空间, 即进程空间.  
          一个服务器通常需要接收大量并发请求, 为每一个请求都创建一个进程,  
          系统开销大, 请求响应效率低, 因此操作系统引进线程.
        - 进程中的一个实体.
        - 进程的一个执行路径.
        - CPU调度和分派的基本单位.
        - 线程本身是不会独立存在.
        - 当前线程CPU时间片用完后, 会让出CPU等下次轮到自己时候在执行.
        - 系统不会为线程分配内存, 线程组之间只能共享所属进程的资源.
        - 线程只拥有在运行中必不可少的资源, 如: 程序计数器, 栈.
        - 线程里的程序计数器就是为了记录该线程让出CPU时候的执行地址,  
          待再次分配到时间片时候就可以从自己私有的计数器指定地址继续执行.
        - 每个线程有自己的栈资源, 用于存储该线程的局部变量和调用栈帧,  
          其它线程无权访问.
    - 关系:
        - 一个程序至少一个进程, 一个进程至少一个线程,  
          进程中的多个线程是共享进程的资源.
        - 一个进程中有多个线程, 多个线程共享进程的堆和方法区资源,  
          但是每个线程有自己的程序计数器, 栈区域.
    - 区别:
        - 本质: 进程是操作系统资源分配的基本单位; 线程是任务调度和执行的基本单位.
        - 内存分配: 系统在运行的时候会为每个进程分配不同的内存空间,  
          建立数据表来维护代码段, 堆栈段和数据段; 除了CPU外, 系统不会为线程分配内存  
          线程所使用的资源来自其所属进程的资源.
        - 资源拥有: 进程之间的资源是独立的, 无法共享; 同一进程的所有线程共享本进程的资源,  
          如: 内, CPU, IO等.
        - 开销: 每个进程都有独立的代码和数据空间, 程序之间的切换会有较大的开销;  
          线程可以看做轻量级的进程, 同一类线程共享代码和数据空间,  
          每个线程都有自己独立的运行程序计数器和栈, 线程之间切换的开销小.
        - 通信: 进程间以IPC方式通信(管道, 信号量, 共享内存, 消息队列, 文件, 套接字等);  
          同一个进程下, 线程间可以共享全局变量, 静态变量等数据进行通信, 做到同步和互斥,  
          以保证数据的一致性.
        - 调度和切换: 线程上下文切换比进程上下文切换快, 代价小.
        - 执行过程: 每个进程都有一个程序执行的入口, 顺序执行序列;  
          线程不能够独立执行, 必须依存在应用程序中, 由程序的多线程控制机制控制.
        - 健壮性: 每个进程之间的资源是独立的, 当一个进程崩溃时, 不会影响其他进程;  
          同一进程的线程共享此线程的资源, 当一个线程发生崩溃时, 此进程也会发生崩溃,  
          稳定性差, 容易出现共享与资源竞争产生的各种问题, 如死锁等.
        - 可维护性: 线程的可维护性, 代码也较难调试, bug难排查.
    - 选择:  
        - 需要频繁创建销毁的优先使用线程. 
        - 需要大量计算, 切换频繁时优先使用线程.
        - 耗时的操作使用线程可提高应用程序的响应.
        - 线程对CPU的使用效率更优, 多机器分布的用进程, 多核分布用线程.
        - 需要跨机器移植, 优先考虑用进程.
        - 需要更稳定, 安全时优先考虑用进程.
        - 需要速度时优先考虑用线程.
        - 并行性要求很高时, 优先考虑用线程.
    